<!doctype html><html lang="pt"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RH – Easycheck</title>
<link rel="stylesheet" href="./style.css"/>
</head><body>
<header><a class="card" href="index.html">← Voltar</a></header>
<main>
  <h2>Recursos Humanos</h2>

  <form id="crit">
    <h3>Criar critérios</h3>
    <label>Título</label><input name="title" value="Assistente Administrativo"/>
    <div class="row">
      <div style="flex:1"><label>Peso Experiência</label><input type="number" name="wE" value="30"/></div>
      <div style="flex:1"><label>Peso Skills</label><input type="number" name="wS" value="40"/></div>
      <div style="flex:1"><label>Peso Idiomas</label><input type="number" name="wL" value="20"/></div>
      <div style="flex:1"><label>Peso Educação</label><input type="number" name="wEd" value="10"/></div>
    </div>
    <label>Skills obrigatórias (vírgula)</label><input name="skills" value="excel,accounting,sage"/>
    <label>Idiomas obrigatórios (vírgula)</label><input name="langs" value="french,german"/>
    <label>Termos proibidos (vírgula)</label><input name="forb" value="idade,foto,religião"/>
    <button>Guardar critérios</button>
  </form>

  <div class="toolbar"><button id="listCrit">Listar critérios</button></div>
  <div id="critList"></div>
  <hr/>

  <form id="up" enctype="multipart/form-data">
    <h3>Upload de CV</h3>
    <label>Nome</label><input name="name" value="João Silva"/>
    <label>Email</label><input name="email" value="joao@example.com"/>
    <input type="file" name="cv" accept=".pdf,.docx,.txt"/>
    <button>Guardar candidato</button>
  </form>

  <div class="row">
    <div style="flex:1"><label>Candidate ID</label><input id="candId" placeholder="preenche após upload"/></div>
    <div style="flex:1"><label>Criteria ID</label><input id="critId" placeholder="seleciona da lista"/></div>
  </div>
  <div class="toolbar">
    <button id="proc1">Processar 1 candidato</button>
    <button id="rankAll">Rankear todos</button>
  </div>
  <pre id="out" class="small"></pre>
</main>

<script>
const API='https://api.easycheckglobal.com/api';
const COMPANY='22871176-0909-4ba5-a642-5db70db2e35f';
async function jget(p){return (await fetch(API+p)).json()}
async function jpost(p,b){return (await fetch(API+p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)})).json()}
function $(s,r=document){return r.querySelector(s)}
function el(t,p={},c=[]){const e=document.createElement(t);Object.assign(e,p);(c||[]).forEach(x=>e.append(x));return e}
function tableFrom(items, cols){const t=el('table'),th=el('thead'),tr=el('tr');cols.forEach(c=>tr.append(el('th',{textContent:c.label})));th.append(tr);t.append(th);const tb=el('tbody');(items||[]).forEach(row=>{const tr=el('tr');cols.forEach(c=>{const td=el('td');td.textContent=typeof c.render=='function'?c.render(row):(row[c.key]??'');tr.append(td)});tb.append(tr)});t.append(tb);return t}

$('#crit').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const out=await jpost('/hr/criteria/save',{
    company_id:COMPANY,title:fd.get('title'),
    weight_experience:+fd.get('wE'),weight_skills:+fd.get('wS'),
    weight_languages:+fd.get('wL'),weight_education:+fd.get('wEd'),
    must_have_skills:(fd.get('skills')||'').split(',').map(s=>s.trim()).filter(Boolean),
    must_have_languages:(fd.get('langs')||'').split(',').map(s=>s.trim()).filter(Boolean),
    forbidden_terms:(fd.get('forb')||'').split(',').map(s=>s.trim()).filter(Boolean)
  });
  if(!out.ok) return alert(out.error||'erro');
  alert('Critérios guardados!'); $('#critId').value=out.criteria.id;
});

$('#listCrit').onclick=async ()=>{
  const data=await jget(`/hr/criteria/list?company_id=${COMPANY}`);
  if(!data.ok) return alert(data.error||'erro');
  const cols=[{key:'id',label:'ID'},{key:'title',label:'Título'},{key:'weight_experience',label:'wE'},{key:'weight_skills',label:'wS'},{key:'weight_languages',label:'wL'},{key:'weight_education',label:'wEd'}];
  $('#critList').innerHTML=''; $('#critList').append(tableFrom(data.criteria,cols));
};

$('#up').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd=new FormData(e.target); fd.append('company_id',COMPANY);
  const r=await fetch(`${API}/hr/upload`,{method:'POST',body:fd}); const out=await r.json();
  if(!out.ok) return alert(out.error||'erro'); alert('Candidato guardado!'); $('#candId').value=out.candidate.id;
});

$('#proc1').onclick=async ()=>{
  const candidate_id=$('#candId').value.trim(); const criteria_id=$('#critId').value.trim();
  if(!candidate_id||!criteria_id) return alert('Preenche Candidate ID e Criteria ID.');
  const out=await jpost('/hr/process-one',{company_id:COMPANY,candidate_id,criteria_id});
  $('#out').textContent=JSON.stringify(out,null,2);
};
$('#rankAll').onclick=async ()=>{
  const criteria_id=$('#critId').value.trim(); if(!criteria_id) return alert('Preenche Criteria ID.');
  const out=await jpost('/hr/rank-all',{company_id:COMPANY,criteria_id});
  $('#out').textContent=JSON.stringify(out,null,2);
};
</script>
</body></html>
